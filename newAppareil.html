<!DOCTYPE html>
<html>
    <head>
       <meta charset="UTF-8">
    <title>Nouvel appareil</title>
    <link rel="stylesheet" href="style_newAppareil.css">
    <script src="https://kit.fontawesome.com/b99e675b6e.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereumjs/browser-builds/dist/ethereumjs-tx/ethereumjs-tx-1.3.3.min.js"></script>
    <script type="text/javascript" src="abiTechniciansWL.js"></script>
    <script type="module" src="abiTechniciansWL.js"></script>
    <script type="text/javascript" src="abiAppareil.js"></script>
    <script type="module" src="abiAppareil.js"></script>
    <script type="text/javascript" src="dataAppareil.js"></script>
    <script type="module" src="dataAppareil.js"></script>
    

  
    </head>
    
    <body>
        
        <div class="wrapper">
            <div class="sidebar">
                <h2>My Repair</h2>
                <ul>
                    <li><a href="profilClient.html"><i class="fas fa-user-circle"></i>Profil client</a></li>
                    <li><a href="deployContract.html"><i class="fas fa-shopping-cart"></i>Nouvel appareil</a></li>
                    <li><a href="infoContrat.html"><i class="fas fa-list-ol"></i>Mes contrats</a></li>
                    
                </ul> 
            
            </div>
        </div>

            <div class="main_content">
                <div class="header">Ajout d'un nouvel appareil</div> 

                <div class="formulaire">
                    <form>
                        <table>
                            <div>
                                Catégorie d'appareil : 
                                <select name="Categorie" id = "cat_select" class = "custom-select" required>
                                    <option value="">--Choisissez une catégorie--</option>
                                    <option value="Froid">Froid</option>
                                    <option value="Chaud">Chaud</option>
                                    <option value="Climatisation">Climatisation</option>
                                </select>
                            </div>
                            <br></br>
                            <div>
                                Type d'appareil : 
                            <select name="Type" id = "type_select" class = "custom-select" required>
                                <option value="">--Choisissez un type d'appareil--</option>
                                <option value="Armoire à température négative">Armoire à température négative</option>
                                <option value="Armoire à température positive">Armoire à température positive</option>
                                <option value="Cellule de refroidissement">Cellule de refroidissement</option>
                                <option value="Grill">Grill</option>
                                <option value="Plaques">Plaques</option>
                                <option value="Four">Four</option>
                                <option value="Chauffe assiettes">Chauffe assiettes</option>
                                <option value="Bain Marie">Bain Marie</option>
                                <option value="Ventilateur">Ventilateur</option>
                            </select>
                            </div>
                            <br></br>
                            <div>
                                Marque : 
                                <input type="text" id="marque" required> </input>
                            </div>
                            <br></br>
                            <div>
                                Référence : 
                                <input type="text" id="ref" required> </input>
                            </div>
                            <br></br>
                            <div>
                                N° de série : 
                                <input type="text" id="n_serie" required> </input>
                            </div>
                        </table>
                    </form>
                    <br><br><br><br>
                    <button onclick = "deployContract()" id = "deploy">Enregistrer les informations</button>

                </form>
                </div>

            </div>
        
            <script type="text/javascript">
                var contractsClientAddr = "0x2C5DBab54909de8c063AF2398d4f10Aa3570baA9";
                var addressTechniciansWL = "0xbd854dE55A8Abf854f7d3e6aF7635C0Cc4c8627E";
                async function loadWeb3() {
                        if (window.ethereum) {
                            window.web3 = new Web3(window.ethereum);
                            window.ethereum.enable();
                        }
                    }    
                    
                async function loadContract(ABI, contractAddress) {
                        return await new window.web3.eth.Contract(ABI, contractAddress);
                    }
        
                async function load() {
                    await loadWeb3();
                    window.contract = await loadContract(ABITechniciansWL, addressTechniciansWL) ;
                    var accounts = await ethereum.request({ method: 'eth_accounts' });
                    account = accounts[0];
                    var techniciansList = await window.contract.methods.getTechnicians().call();
                    /*if(!techniciansList.includes(account)){
                        document.getElementById("deploy").disabled = true;
                    }*/
                }
                
                async function deployContract() {
                    document.getElementById("deploy").disabled = true;
                    var accounts = await ethereum.request({ method: 'eth_accounts' });
                    account = accounts[0];
                    var whitelistedAddresses = ["0x7755414216938522c7dEC813F143dBc0ad6dc84A","0x542b817700C2A772E0DE966673fF6B5D39734677",
                                        "0x4415FC24cbA9CEC76cCD5ad313aa02363651D3BA","0xC8134fA8C874359e9aa8ECd005aF6a409446a59A"]

                    
                    //déployer contract

                    web3.eth.getTransactionCount(account,async(err,txCount)=>{
                        //smart contract data 
                        const data = dataAppareil;
                        let myContract = new web3.eth.Contract(ABIAppareil);
                        myContract.deploy({
                            data: data, 
                        })
                        .send({
                            from: account,
                            nonce : web3.utils.toHex(txCount),
                            gasLimit :web3.utils.toHex(4000000),
                            gasPrice : web3.utils.toHex(web3.utils.toWei('10','gwei'))
                        })
                        .on('receipt',async function(receipt){
                            console.log("Contract address : " + receipt.contractAddress);
                            window.contract = await loadContract(ABIAppareil,receipt.contractAddress);
                            console.log(window.contract);
                            //addAddressesToWL(whitelistedAddresses);
                            // TO DO : récupérer contratsClientAddr depuis précédente page html 
                            // 
                            await setInfoAppareil(contractsClientAddr);
                        });
                    });
                }
        



                async function setInfoAppareil(contractsClientAddr) {                 
                    var account = await web3.eth.getAccounts();
                    account = account[0];
                    const cat = document.getElementById('cat_select').value;
                    const a_type = document.getElementById('type_select').value;
                    const brand = document.getElementById('marque').value;
                    const ref = document.getElementById('ref').value;
                    const serial_n = document.getElementById('n_serie').value;
                    const Appareil = await window.contract.methods.setAppareil(contractsClientAddr,cat,a_type,brand,ref,serial_n).send({from: account});
                }
                

                load();

            </script>
    



    
    </body>
</html>