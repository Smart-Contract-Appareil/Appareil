<!DOCTYPE html>
<html>
  <head>
    <title>Mes contrats</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style_infoContrat.css">
    <script src="https://kit.fontawesome.com/b99e675b6e.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script type="text/javascript" src="abi.js"></script>
  

    <body onload="getInfoAppareil()">
      <div class="wrapper">
          <div class="sidebar">
            <h2><i class="fas fa-tools"></i> My Repair</h2>
              <ul>
                  <li><a href="profilClient.html"><i class="fas fa-user-circle"></i>Profil client</a></li>
                  <li><a href="deployContract.html"><i class="fas fa-shopping-cart"></i>Nouvel appareil</a></li>
                  <li><a href="infoContrat.html"><i class="fas fa-list-ol"></i>Mes contrats</a></li>
                  
                
                
              </ul> 
          </div>
          <div class="main_content">
              <div class="header">Mes contrats</div>  
              <div class="app">
                <h1>Appareil XXXX</h1>
                <div class="info">
                    <h2><i class="fas fa-info" style="color:black" onclick="getInfoAppareil()"></i> Informations de l'appareil</h2>
                    <p>
                      Numéro du contrat : <span id="nb_contract">Loading...</span> <br></br>
                      Catégorie : <span id="categorie">Loading...</span> <br></br>
                      Type : <span id="a_type">Loading...</span> <br></br>
                      Marque : <span id="marque">Loading...</span> <br></br>
                      Référence : <span id="ref">Loading...</span> <br></br>
                      N° de série : <span id="nb_serie">Loading...</span> <br></br>
                      Statut: <span id="statut">Loading...</span> <br></br>
              
                    </p>
                    <button onclick="dmdIntervention()" class="button1">Demande d'intervention</button><br><br>
                    <button onclick="openIntervention()" class="button2">Travaux d'intervention</button>
                    
                </div>

                <div class="hist">
                    <h2><i class="fas fa-clipboard-list" style="color:black"></i> Historique de l'appareil</h2>
                    <table>
                      <tr>
                        <th>Date</th>
                        <th>Numéro de la demande</th>
                        <th>Type d'intervention</th>
                        <th>Commentaires (Travaux d'intervention)</th>
                      </tr>
                      <tr>
                        <td>01/12/2020</td>
                        <td>25357</td>
                        <td>Maintenance</td>
                        <td>Rien d'anormal</td>
                      </tr>
                      <tr>
                        <td>15/09/2019</td>
                        <td>89624</td>
                        <td>Réparation</td>
                        <td>N/A</td>
                      </tr>
      
                    </table>
              </div>
            </div>
          </div>
      </div>

      <script type="text/javascript">

      //Connexion metamask
        var contractAddress = "0xDFf05A5D3c2e7680757e35487286378EF95bc59E"; //Adresse contrat déployé
        var account = "0x542b817700C2A772E0DE966673fF6B5D39734677"; //Adresse compte metamask

        async function loadWeb3() {
                if (window.ethereum) {
                    window.web3 = new Web3(window.ethereum);
                    window.ethereum.enable();
                }
            }    
            
        async function loadContract() {
                return await new window.web3.eth.Contract(ABI, contractAddress);
            }

        async function load() {
            await loadWeb3();
            window.contract = await loadContract();
        }

        load();

        //Récupère les informations de l'appareil (du contrat)
        async function getInfoAppareil() {

          const cat1 = await window.contract.methods.categorie().call()
          const a_type1 = await window.contract.methods.a_type().call()
          const marque1 = await window.contract.methods.brand().call()
          const ref1 = await window.contract.methods.refer().call()
          const nb_serie1 = await window.contract.methods.serial_n().call()
          const statut = await window.contract.methods.statut().call()
          document.getElementById("categorie").innerHTML = cat1;
          document.getElementById("a_type").innerHTML = a_type1;
          document.getElementById("marque").innerHTML = marque1;
          document.getElementById("ref").innerHTML = ref1;
          document.getElementById("nb_serie").innerHTML = nb_serie1;
          document.getElementById("statut").innerHTML = statut;
          document.getElementById("nb_contract").innerHTML = contractAddress;
          
        
        }

        // En cliquant sur le bouton travaux d'intervention :
        //Si le statut de l'appareil est à 0 la page réparation s'ouvrira sinon si il est à 1 la page maintenance
        function openIntervention(){
          statut = document.getElementById("statut");
          if (statut == "1"){
            window.location.href="logMaintenance.html"
          }
          else {
            window.location.href="logReparation.html"
          }
        }

        async function dmdIntervention(){
          const Appareil = await window.contract.methods.askIntervention().send({from: account});
        }

      </script>

  </body>
</html>