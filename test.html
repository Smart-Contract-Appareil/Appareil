<!DOCTYPE html>
<html>
    <head>
        <head>
            <meta charset='utf-8'>
            <meta http-equiv='X-UA-Compatible' content='IE=edge'>
            <title>Web 3 Demo</title>
            <meta name='viewport' content='width=device-width, initial-scale=1'>

            <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
            <script type="text/javascript" src="abi.js"></script>
        </head>
    </head>

    <body>

        Web 3 Demo
        <br >
        <button onclick="printCoolNumber();">Print Cool Number</button>
        <button onclick="changeCoolNumber();">Change Cool Number</button>
        <br /><br />

        <a href = "changeInfo.html">
            <button onclick ="passContractAddress">Set appareil information</button>
        </a>
        Status: <span id="status">Loading...</span>
        <script type="text/javascript">            
            var contractAddress = '0x493aE4B525885dd1B3164ecC27531D632d4e3BFe';

            function passContractAddress(){
                localStorage.setItem("contractAddress", contractAddress );
                return False;
            }
            async function loadWeb3() {
                if (window.ethereum) {
                    window.web3 = new Web3(window.ethereum);
                    window.ethereum.enable();
                }
            }    
            
            async function loadContract() {
                return await new window.web3.eth.Contract(ABI, contractAddress);
            }

            async function setInfoAppareil() {
                const cat = document.getElementById('categorie');
                const a_type = document.getElementById('type');
                const brand = document.getElementById('marque');
                const ref = document.getElementById('reference');
                const serial_n = document.getElementById('n_serie');
                await window.contract.setAppareil(cat,a_type,brand,ref,serial_n) 
            }
            async function printCoolNumber() {
                updateStatus('fetching Cool Number...');
                const coolNumber = await window.contract.methods.coolNumber().call();
                updateStatus(`coolNumber: ${coolNumber}`);
            }

            async function changeCoolNumber() {
                const value = Math.floor(Math.random() * 100);
                updateStatus(`Updating coolNumber with ${value}`);
                const account = '0xC8134fA8C874359e9aa8ECd005aF6a409446a59A';
                const coolNumber = await window.contract.methods.setCoolNumber(value).send({from: account});
                updateStatus('Updated.');
            }

            async function load() {
                await loadWeb3();
                window.contract = await loadContract();
                updateStatus('Ready!');
            }

            function updateStatus(status) {
                const statusEl = document.getElementById('status');
                statusEl.innerHTML = status;
                console.log(status);
            }

            load();
        </script>
    </body>

</html>