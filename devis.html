<!DOCTYPE html>
<html>
    <head>
        <head>
            <meta charset='utf-8'>
            <meta http-equiv='X-UA-Compatible' content='IE=edge'>
            <title>Web 3 Demo</title>
            <meta name='viewport' content='width=device-width, initial-scale=1'>
            <link rel="stylesheet" href="style_devis.css">
            <script src="https://kit.fontawesome.com/b99e675b6e.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>
            <script type="text/javascript" src="abi2.js"></script>
        </head>
    </head>

    <body>
      <div class="wrapper">
          <div class="sidebar">
            <h2><i class="fas fa-tools"></i> My Repair</h2>
              <ul>
                  <li><a href="profilClient.html"><i class="fas fa-user-circle"></i>Profil client</a></li>
                  <li><a href="deployContract.html"><i class="fas fa-shopping-cart"></i>Nouvel appareil</a></li>
                  <li><a href="infoContrat.html"><i class="fas fa-list-ol"></i>Mes contrats</a></li>            
              </ul> 
          </div>
          <div class="main_content">
              <div class="header">Mes contrats</div>  
              <div class="app">
                <h1>Appareil XXXX</h1>
                <div class="info">
                    <h2><i class="fas fa-info" style="color:black"></i> Nouveau document</h2>

                        <form id="Data">
                            <fieldset>
                            <legend><b>Informations</b></legend>
                            <div>
                                <select id = "type_doc" class = "type_doc_select" required>
                                    <option value="">--Type document--</option>
                                    <option value="Devis">Devis</option>
                                    <option value="Facture">Facture</option>
                                </select><br><br>  
                                &emsp;Nom entreprise : <input id="company" type="text" value="" required/><br><br>
                                &emsp;Devis établi par : <input id="intervenant" type="text" value="" required/>
                                
                            </div>
                            </fieldset><br>
                            <fieldset>
                            <legend><b>Remplir les éléments</b></legend>
                            <div>
                                <input id="despt1" type="text" value="" placeholder="Description"/> <input id="qte1" type="text" value="" placeholder="Quantité"/> <input id="prixU1" type="text" value="" placeholder="Prix unitaire"/><br><br>
                                <input id="despt2" type="text" value="" placeholder="Description"/> <input id="qte2" type="text" value="" placeholder="Quantité"/> <input id="prixU2" type="text" value="" placeholder="Prix unitaire"/><br><br>
                                <input id="despt3" type="text" value="" placeholder="Description"/> <input id="qte3" type="text" value="" placeholder="Quantité"/> <input id="prixU3" type="text" value="" placeholder="Prix unitaire"/><br><br>
                                <input id="despt4" type="text" value="" placeholder="Description"/> <input id="qte4" type="text" value="" placeholder="Quantité"/> <input id="prixU4" type="text" value="" placeholder="Prix unitaire"/><br><br>
                                <input id="despt5" type="text" value="" placeholder="Description"/> <input id="qte5" type="text" value="" placeholder="Quantité"/> <input id="prixU5" type="text" value="" placeholder="Prix unitaire"/><br><br>
                                
                            </div>
                            </fieldset><br>
                        </form>

                            <input type = "button" value = "Enregistrer" class="button1" onclick = "setInfoDevis()">
                    
                </div>

                <div class="hist">
                    <h2><i class="fas fa-clipboard-list" style="color:black"></i> Tableau des pièces jointes</h2>
                    <table class ="historique">
                        <thead>
                            <tr>
                                <th>Identifiant</th>
                                <th>Type de document</th>
                                <th>Date/Heure</th>
                                <th>Nom de l'entreprise</th>
                                <th>Nom de l'intervenant</th>
                                <th>Prix total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                </div>

            <br></br>

        <script type="text/javascript">            
            var contractAddress = '0x2Dd483dAaAD1BcFB410AE7de30fc90c93c84fc4f';
            var account = "0xC8134fA8C874359e9aa8ECd005aF6a409446a59A" ;

            class evt{
            id;
            type_doc;
            time_date_transac;
            nom_entreprise;
            intervenant;
            prix_tot; 
            
            constructor(id, type_doc, time_date_transac, nom_entreprise, intervenant, prix_tot){
                this.id = id;
                this.type_doc = type_doc;
                this.time_date_transac = time_date_transac;
                this.nom_entreprise = nom_entreprise
                this.intervenant = intervenant;
                this.prix_tot = prix_tot;
            }
            //Getters
            get id(){return this.id;}
            get type_doc(){return this.type_doc;}
            get time_date_transac(){return this.time_date_transac;}
            get nom_entreprise(){return this.nom_entreprise};
            get intervenant(){return this.intervenant;}  
            get prix_tot(){return this.prix_tot;}  
        }

            async function loadWeb3() {
                if (window.ethereum) {
                    window.web3 = new Web3(window.ethereum);
                    window.ethereum.enable();
                }
            }    
          
            async function loadContract() {
                return await new window.web3.eth.Contract(ABI2, contractAddress);
            }

        //Envoyer les données du devis dans la blockchain
            async function setInfoDevis() {

                const type_doc = document.getElementById('type_doc').value;
                const company = document.getElementById('company').value;
                const intervenant = document.getElementById('intervenant').value;

                const lib_1 = document.getElementById('despt1').value;
                const lib_2 = document.getElementById('despt2').value;
                const lib_3 = document.getElementById('despt3').value;
                const lib_4 = document.getElementById('despt4').value;
                const lib_5 = document.getElementById('despt5').value;

                const qte1 = document.getElementById('qte1').value;
                const qte2 = document.getElementById('qte2').value;
                const qte3 = document.getElementById('qte3').value;
                const qte4 = document.getElementById('qte4').value;
                const qte5 = document.getElementById('qte5').value;

                const prixU1 = document.getElementById('prixU1').value;
                const prixU2 = document.getElementById('prixU2').value;
                const prixU3 = document.getElementById('prixU3').value;
                const prixU4 = document.getElementById('prixU4').value;
                const prixU5 = document.getElementById('prixU5').value;

                const prixTot1 = qte1 * prixU1;
                const prixTot2 = qte2 * prixU2;
                const prixTot3 = qte3 * prixU3;
                const prixTot4 = qte4 * prixU4;
                const prixTot5 = qte5 * prixU5;

                const prixTOT = (prixTot1 + prixTot2 + prixTot3 + prixTot4 + prixTot5).toString();

                const dta_1 = qte1.concat('_', prixU1, '_', prixTot1);
                const dta_2 = qte2.concat('_', prixU2, '_', prixTot2);
                const dta_3 = qte3.concat('_', prixU3, '_', prixTot3);
                const dta_4 = qte4.concat('_', prixU4, '_', prixTot4);
                const dta_5 = qte5.concat('_', prixU5, '_', prixTot5);

            
                const DataPJ = await window.contract.methods.setDataPJ(type_doc, company, intervenant, prixTOT).send({from: account});
                const ItemPJ = await window.contract.methods.setItemPJ(lib_1, lib_2, lib_3, lib_4, lib_5, dta_1, dta_2, dta_3, dta_4, dta_5).send({from: account});
                }

            async function loadEvents(){

                    var arrayEvents = new Array();
                    await window.contract.events.addAttachment(
                    {
                        fromBlock: 0,
                        toBlock: 'latest'
                    }, 
                    async(err, event) => {   
                    //console.log(err, event)
                    // Filtre les events (sans les ajouts d'adresses à la whiteList)
                        console.log(event);
                        arrayEvents.push(
                            new evt(
                                event.returnValues.id,
                                event.returnValues.type_doc,
                                (new Date(event.returnValues.date * 1000)).toLocaleString(),
                                event.returnValues.company,
                                event.returnValues.intervenant,
                                event.returnValues.prix_tot
                            )
                        ); 
                    });
                    return arrayEvents;
            }

            async function getDevis(identifiant) {
                var dd = {
                content: [
                    {text: 'Entreprise de plomberie\n', bold: true, fontSize: 10},
                    {text: 'Durand SARL \n 10 rue principale\n 34000 Montpellier\n 06.45.12.15.47\n durand@gmail.com\n N° Siret :380 000 000 000XX RCS Montpellier\n\n', fontSize: 10},
                    {
                        text: 'Devis Numéro 10 \n',
                        style: 'header',
                        alignment: 'center'
                    },
                    {text: 'Travaux de réparation sur climatisation \n\n\n', alignment: 'center', italics:true},
                    {
                        table: {
                            widths: [200, 50, 50, 70, 70],
                            body: [
                                [{text: 'Désignation', fillColor: '#A1E2D4'}, {text: 'Quantité', fillColor: '#A1E2D4'}, {text: 'tvs', fillColor: '#A1E2D4'}, {text: 'P.U. HT', fillColor: '#A1E2D4'}, {text: 'Total HT', fillColor: '#A1E2D4'}],
                                ['Sample value 1', '1', '10%', '0€', '200,00€'],
                                ['Sample value 1', '2', '10%', '20€', '40,00€'],
                                ['Sample value 1', '4', '10%', '15€', '15,00€'],
                                [{text: '', border: [false, false, false, false] }, {text: '', border: [false, false, false, false]}, {text: '', border: [false, false, false, false]}, {text: 'Total HT', alignment: 'right', italics:true, border: [false, false, false, false]}, {text: '255,00€'}],
                                [{text: '', border: [false, false, false, false] }, {text: '', border: [false, false, false, false]}, {text: '', border: [false, false, false, false]}, {text: 'TVA', alignment: 'right', italics:true, border: [false, false, false, false]}, {text: '25,00€'}],
                                [{text: '', border: [false, false, false, false] }, {text: '', border: [false, false, false, false]}, {text: '', border: [false, false, false, false]}, {text: 'TTC', alignment: 'right', italics:true, border: [false, false, false, false]}, {text: '280,00€'}]
                            ],
                        },
                    },
                ],
                styles: {
                    header: {
                        fontSize: 18,
                        bold: true,
                        alignment: 'justify'
                    }
                }
            }
            //test pour pdf
            pdfMake.createPdf(dd).download();
            }

            async function load() {
                await loadWeb3();
                window.contract = await loadContract();
                // Récupère tous les events
                var events = await loadEvents();

                setTimeout(function(){ 
                let tempEvents = events;
                if(tempEvents.length>0){
                    /// MUST DO EVERY TREATMENT HERE FROM NOW ON ///
                    console.log("dans setTimeout", events);
                    createTable(events);
                }
                else{
                    console.log("length = 0");
                    console.log("Test Emma", events);
                }
            }, 2000);
            }

            /*
            * Créer des lignes pour peupler le tableau avec les evt présents dans l'array
            */
            function createRow(evt){
            //entree = {txhash,blockn,time_date,type,commentaire}
            let tr = document.createElement('tr');

            const tdID = document.createElement('td');
            tdID.innerText = evt.id ;
            tr.appendChild(tdID);

            const tdTypDoc = document.createElement('td');
            tdTypDoc.innerText = evt.type_doc ;
            tr.appendChild(tdTypDoc);

            const tdDate = document.createElement('td');
            tdDate.innerText = evt.time_date_transac ;
            tr.appendChild(tdDate);

            const tdEntreprise = document.createElement('td');
            tdEntreprise.innerText = evt.nom_entreprise ;
            tr.appendChild(tdEntreprise);

            const tdIntervenant = document.createElement('td');
            tdIntervenant.innerText = evt.intervenant ;
            tr.appendChild(tdIntervenant);

            const tdPrix_Tot = document.createElement('td');
            tdPrix_Tot.innerText = evt.prix_tot ;
            tr.appendChild(tdPrix_Tot);

            const action = document.createElement('td');
            action.innerHTML = '<button type="button" onclick = "getDevis(\'' + evt.id + '\')">Télécharger le devis</button>';
            tr.appendChild(action);    

            return tr
            }

            function createTable(events){
            const tbody = document.querySelector('.historique tbody');
            events.forEach(evt => tbody.appendChild(createRow(evt)));
            }
            load();

        </script>
    </body>

</html>