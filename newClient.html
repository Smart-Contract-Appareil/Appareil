<!DOCTYPE html>
<html>
    <head>
       <meta charset="UTF-8">
    <title>Nouveau client</title>
    <link rel="stylesheet" href="style_newClient.css">
    <script src="https://kit.fontawesome.com/b99e675b6e.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script type="text/javascript" src="abiTechniciansWL.js"></script>
    <script type="module" src="abiTechniciansWL.js"></script>
    <script type="text/javascript" src="abiContratsClient.js"></script>
    <script type="module" src="abiContratsClient.js"></script>
    <script type="text/javascript" src="dataContratsClient.js"></script>
    <script type="module" src="dataContratsClient.js"></script>
    


</head>
    
<body>
    
    <div class="wrapper">
        <div class="sidebar">
            <h2><i class="fas fa-tools"></i> My Repair</h2>
            <ul>
                <li><a href="profilClient.html"><i class="fas fa-user-circle"></i>Profil client</a></li>
                <li><a href="deployContract.html"><i class="fas fa-shopping-cart"></i>Nouvel appareil</a></li>
                <li><a href="infoContrat.html"><i class="fas fa-list-ol"></i>Mes contrats</a></li>
                
            </ul> 
        
        </div>
    </div>

        <div class="main_content">
            <div class="header">Les clients</div>
            <div class='titre'>
                <h2><i class="fas fa-folder-plus" style="color:black"></i> Ajout d'un nouveau client</h2>
            </div>
            <div class='formulaire'>
                <form>
                    
                    <div class="input-container">
                    <i class="fa fa-building icon"></i>
                    <input class="input-field" type="text" placeholder="Nom entreprise" id="nameEntrp">
                    </div>
                
                    <div class="input-container">
                    <i class="fa fa-address-card icon"></i>
                    <input class="input-field" type="text" placeholder="Adresse postale" id="adressePost">
                    </div>
                
                    <div class="input-container">
                    <i class="fa fa-map-marker icon"></i>
                    <input class="input-field" type="text" placeholder="Code postal" id="codePost">
                    </div>

                    <div class="input-container">
                    <i class="fa fa-map icon"></i>
                    <input class="input-field" type="text" placeholder="Ville" id="ville">
                    </div>
                    
                    <div class="input-container">
                    <i class="fa fa-at icon"></i>
                    <input class="input-field" type="email" placeholder="Email" id="email">
                    </div>
                    
                    <div class="input-container">
                    <i class="fa fa-phone icon"></i>
                    <input class="input-field" type="tel" placeholder="Numéro de téléphone" id="numTel">
                    </div>

                
                    <button onclick = "deployContract()" class="btn">Enregistrer</button>
                </form>
            </div>
            <button class="button1"><a href="tabClient.html"><i class="fas fa-arrow-left"></i>&nbsp Retour</button>
        </div>

            <script type="text/javascript">
                var addressTechniciansWL = "0xbd854dE55A8Abf854f7d3e6aF7635C0Cc4c8627E";; //Adresse contrat déployé
        
                async function loadWeb3() {
                        if (window.ethereum) {
                            window.web3 = new Web3(window.ethereum);
                            window.ethereum.enable();
                        }
                    }    
                    
                async function loadContract(ABI, contractAddress) {
                    return await new window.web3.eth.Contract(ABI, contractAddress);
                }
        
                async function load() {
                    await loadWeb3();
                    window.contract = await loadContract(ABITechniciansWL, addressTechniciansWL) ;
                    var accounts = await ethereum.request({ method: 'eth_accounts' });
                    account = accounts[0];
                    //console.log(window.contract);
                    //console.log(account);
                    var techniciansList = await window.contract.methods.getTechnicians().call();
                    /*if(!techniciansList.includes(account)){
                        document.getElementById("deployContratsClient").disabled = true;
                    }*/
                }
        
                load();
                
                function test(){
                    console.log("test bouton");
                }


                async function deployContract(){
                    var accounts = await ethereum.request({ method: 'eth_accounts' });
                    account = accounts[0];
                    web3.eth.getTransactionCount(account,async(err,txCount)=>{
                        //smart contract data 
                        const data = dataContratsClient;
                        let myContract = new web3.eth.Contract(ABIContratsClient);
                        myContract.deploy({
                            data: data, 
                        })
                        .send({
                            from: account,
                            nonce : web3.utils.toHex(txCount),
                            gasLimit :web3.utils.toHex(4000000),
                            gasPrice : web3.utils.toHex(web3.utils.toWei('10','gwei'))
                        })
                        .on('receipt',async function(receipt){
                            console.log("Contract address : " + receipt.contractAddress);
                            window.contract = await loadContract(ABIContratsClient,receipt.contractAddress);
                            console.log(window.contract);
                            await setInfoClient();
                        });
                    });
                }

                async function setInfoClient() {
                    // !!! 2 lignes à rajouter dans toutes les fonctions send
                    var accounts = await ethereum.request({ method: 'eth_accounts' });
                    account = accounts[0];
                    //console.log("mon compte : "+ account);
                    const nom = document.getElementById('nameEntrp').value;
                    const adresse_postale = document.getElementById('adressePost').value;
                    const code_postal = document.getElementById('codePost').value;
                    const ville = document.getElementById('ville').value;
                    const telephone = document.getElementById('email').value;
                    const email = document.getElementById('numTel').value;
                    await window.contract.methods.setClient(nom,adresse_postale,code_postal,ville,telephone,email).send({from: account});
                } 
            </script>
    



    
    </body>
</html>